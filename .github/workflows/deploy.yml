name: üöÄ Notion Auto-Update Tasks with Logging

on:
  push:
    branches:
      - main
      - dev
  workflow_dispatch:  # allows manual run
  schedule:
    - cron: '0 * * * *'  # optional: run every hour

jobs:
  update-notion:
    runs-on: ubuntu-latest
    env:
      NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
      NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}

    steps:
      # 1Ô∏è‚É£ Checkout repo
      - name: üß∞ Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Debug secrets
      - name: üîç Debug Notion secrets
        run: |
          echo "Database ID: $NOTION_DATABASE_ID"
          echo "Token is set: ${NOTION_TOKEN:+Yes}"

      # 3Ô∏è‚É£ Query Notion database
      - name: üîé Query Notion database
        run: |
          echo "Querying Notion database ${NOTION_DATABASE_ID}..."
          curl -X POST "https://api.notion.com/v1/databases/${NOTION_DATABASE_ID}/query" \
            -H "Authorization: Bearer ${NOTION_TOKEN}" \
            -H "Content-Type: application/json" \
            -H "Notion-Version: 2022-06-28" \
            -o notion-query.json
          echo "‚úÖ Notion database queried successfully."

      # 4Ô∏è‚É£ Save JSON artifact (optional)
      - name: üì¶ Upload Notion query JSON
        uses: actions/upload-artifact@v4
        with:
          name: notion-query
          path: notion-query.json

      # 5Ô∏è‚É£ Auto-update all tasks with Status "Todo" ‚Üí "Done" + log task names
      - name: üîÑ Update all pending tasks
        run: |
          echo "Updating all pending tasks to Done..."
          
          # Loop over all pages with Status = Todo
          PAGE_IDS=$(jq -r '.results[] | select(.properties.Status.select.name=="Todo") | .id' notion-query.json)
          TASK_NAMES=$(jq -r '.results[] | select(.properties.Status.select.name=="Todo") | .properties["Task Name"].title[0].text.content' notion-query.json)

          if [ -z "$PAGE_IDS" ]; then
            echo "No tasks with Status 'Todo' found. Nothing to update."
          else
            i=0
            for PAGE_ID in $PAGE_IDS; do
              TASK_NAME=$(echo "$TASK_NAMES" | sed -n "$((i+1))p")
              echo "Updating task: '$TASK_NAME' (Page ID: $PAGE_ID)"
              curl -X PATCH "https://api.notion.com/v1/pages/$PAGE_ID" \
                -H "Authorization: Bearer ${NOTION_TOKEN}" \
                -H "Content-Type: application/json" \
                -H "Notion-Version: 2022-06-28" \
                -d '{
                      "properties": {
                        "Status": { "select": { "name": "Done" } }
                      }
                    }'
              echo "‚úÖ Updated task '$TASK_NAME' to Done"
              i=$((i+1))
            done
          fi

      # 6Ô∏è‚É£ Placeholder deploy step
      - name: üöÄ Deployment placeholder
        if: github.ref == 'refs/heads/main'
        run: |
          echo "Deployment placeholder ‚Äî pipeline works!"

